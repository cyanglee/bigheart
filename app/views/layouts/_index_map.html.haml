.modal.fade{:id => "toggle_map", :style => "display: none;"}
  .modal-dialog
    .modal-content
      .modal-header
        %a.close{"data-dismiss" => "modal"}
          %i.fa.fa-times-circle
        %h3.modal-title 查看附近有誰需要幫助
      .modal-body
        #index_map{"data-action" => "index", "data-details" => "#{@details.to_json}", "data-titles" => "#{@details.keys}"}
      .modal-footer{style: "margin-top: 0px"}
        %button.btn.btn-default{"data-dismiss" => "modal", type: "button"} 關閉
:javascript
    var index_map = $('#index_map'),
        details = index_map.data('details'),
        titles = index_map.data('titles'),
        action = index_map.data('action');

        $('#toggle_map').on('shown.bs.modal', function () {
            GMaps.geolocate({
                success: function(position){
                    var map = new GMaps({
                        el: '#index_map',
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        height: '558px',
                        width: '558px',
                        zoom: 14
                    });
                    map.setCenter(position.coords.latitude, position.coords.longitude);
                    map.addMarker({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        title: 'You are here.',
                        icon: '/assets/green-dot.png',
                        infoWindow: {
                            content: '<p>你在這邊!</p>'
                        }
                    });

                    for (t = 0; t < titles.length; t++){
                        var title = details[titles[t]]
                            latitude = title['latitude'],
                            longitude = title['longitude'];
                        for (i = 0; i < latitude.length; i++){
                            var user_point = new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                                story_point = new google.maps.LatLng(latitude[i], longitude[i]),
                                distance = google.maps.geometry.spherical.computeDistanceBetween(user_point, story_point);
                            if(distance < 5000){
                                map.addMarker({
                                    lat: latitude[i],
                                    lng: longitude[i],
                                    icon: '/assets/red-dot.png',
                                    infoWindow: {
                                        content: '<p>' + titles[t] + '</p>'

                                    }
                                });
                            }
                        }
                    }
                },
                error: function(error){
                    alert('Geolocation failed: '+error.message);
                },
                not_supported: function(){
                    alert("Your browser does not support geolocation");
                }
            });
        });